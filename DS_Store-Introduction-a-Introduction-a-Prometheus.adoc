<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Introduction à Prometheus</title>
    <meta name="description" content="" />
    <link rel="alternate" hreflang="fr" href="http://blog.ellixo.com/" />
    <link href="//fonts.googleapis.com/css?family=Noto+Sans:300,400,700" rel="stylesheet" type="text/css">
    <link href="//fonts.googleapis.com/css?family=Noto+Serif:400,700,400italic" rel="stylesheet" type="text/css">
    <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link href="//blog.ellixo.com/themes/Ellixo/assets/css/style.css?v=1.0.0" rel="stylesheet" type="text/css">
    <link href="//blog.ellixo.com/themes/Ellixo/assets/css/animate.min.css?v=1.0.0" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/styles/default.min.css">
    <link href="//blog.ellixo.com/themes/Ellixo/favicon.ico" rel="shortcut icon">
    <link rel="canonical" href="http://blog.ellixo.comDS_Store-Introduction-a-Introduction-a-Prometheus.adoc" />
    
    <meta property="og:site_name" content="Blog Ellixo" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Introduction à Prometheus" />
    <meta property="og:description" content="Prometheus Prometheus est un des derniers nés dans le domaine des solutions de monitoring (développé chez SoundCloud majoritairement en Go) - il vient marcher sur les plate-bandes de solutions comme Graphite en apportant une approche relativement différente. En effet, au-delà..." />
    <meta property="og:url" content="http://blog.ellixo.comDS_Store-Introduction-a-Introduction-a-Prometheus.adoc" />
    <meta property="article:published_time" content="Invalid date" />
    <meta property="article:modified_time" content="2015-08-17T20:19:38.135Z" />
    <meta property="article:tag" content="Prometheus" />
    <meta property="article:tag" content="Monitoring" />
    <meta property="article:tag" content="Spring Boot" />
    <meta property="article:tag" content="Docker" />
    <meta property="article:tag" content="OpenData" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Introduction à Prometheus" />
    <meta name="twitter:description" content="Prometheus Prometheus est un des derniers nés dans le domaine des solutions de monitoring (développé chez SoundCloud majoritairement en Go) - il vient marcher sur les plate-bandes de solutions comme Graphite en apportant une approche relativement différente. En effet, au-delà..." />
    <meta name="twitter:url" content="http://blog.ellixo.comDS_Store-Introduction-a-Introduction-a-Prometheus.adoc" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "Blog Ellixo",
    "author": {
        "@type": "Person",
        "name": "Grégory Le Bonniec",
        "image": "https://avatars.githubusercontent.com/u/9615799?v=3",
        "url": "undefined/author/undefined",
        "sameAs": null
    },
    "headline": "Introduction à Prometheus",
    "url": "http://blog.ellixo.comDS_Store-Introduction-a-Introduction-a-Prometheus.adoc",
    "datePublished": "Invalid date",
    "dateModified": "2015-08-17T20:19:38.135Z",
    "keywords": "Prometheus,  Monitoring,  Spring Boot,  Docker,  OpenData",
    "description": "Prometheus Prometheus est un des derniers nés dans le domaine des solutions de monitoring (développé chez SoundCloud majoritairement en Go) - il vient marcher sur les plate-bandes de solutions comme Graphite en apportant une approche relativement différente. En effet, au-delà..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="Blog Ellixo" href="http://blog.ellixo.com/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template tag-Prometheus tag-Monitoring tag-Spring-Boot tag-Docker tag-OpenData">
    <header id="header" class="animated fadeIn">
    <div class="header-background">
    <section class="blog-content">
        <a href="http://blog.ellixo.com"><img src="/images/logo_w.png" class="logo"/></a>
        <span class="blog-description">Le Blog d&#x27;Ellixo</span>
        <nav class="links fadeIn animated">
            <ul>
                <!-- <li class="rss"><a title="RSS Feed" href="/rss/"><i class="fa fa-fw fa-rss-square"></i></a></li> -->
        
            </ul>
        </nav>
    </section>
    <section class="header-content">
        <h1 class="post-title animated fadeInUp">Introduction à Prometheus</h1>
        <span class="post-data"><span class="date animated fadeInUp"><i class="fa fa-clock-o"></i> <time class="timesince date" data-timesince="Invalid date" datetime="Invalid date" title="Invalid date">Invalid date<ago class="ago"></time></span>
            <span class="tags animated fadeInUp"><i class="fa fa-tags"></i> <a href="http://blog.ellixo.com/tag/Prometheus">Prometheus</a>, <a href="http://blog.ellixo.com/tag/Monitoring"> Monitoring</a>, <a href="http://blog.ellixo.com/tag/Spring-Boot"> Spring Boot</a>, <a href="http://blog.ellixo.com/tag/Docker"> Docker</a>, <a href="http://blog.ellixo.com/tag/OpenData"> OpenData</a></span>
            <span class="author animated fadeInUp"><i class="fa fa-user"></i> <a href="">Grégory Le Bonniec</a></span></span>
    </section>
    </div>
</header>
<main id="main" class="content">
    <article itemtype="http://schema.org/BlogPosting" class="animated fadeIn content post post tag-Prometheus tag-Monitoring tag-Spring-Boot tag-Docker tag-OpenData">
        <section class="post-content">
            <h1 id="_prometheus" class="sect0">Prometheus</h1>
<div class="paragraph">
<p><a href="http://prometheus.io/">Prometheus</a> est un des derniers nés dans le domaine des solutions de monitoring (développé chez SoundCloud majoritairement en Go) - il vient marcher sur les plate-bandes de solutions comme Graphite en apportant une approche relativement différente.</p>
</div>
<div class="paragraph">
<p>En effet, au-delà du stockage de métriques, Prometheus fournit de nombreuses fonctionnalités :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>une collecte active des métriques (ie. Prometheus collecte les données des systèmes monitorés via des endpoints fournis par ces derniers - si besoin, Prometheus fournit également un système de push pour les systèmes ne pouvant pas fournir de point d&#8217;entrée)</p>
</li>
<li>
<p>un système d&#8217;alerting (email, slack, webhook &#8230;&#8203;)</p>
</li>
<li>
<p>un gestionnaire de dashboard dédié (PromDash)</p>
</li>
<li>
<p>un modèle de données clé/valeur (système de labels permettant une identification fine des métriques)</p>
</li>
<li>
<p>un système simple de requêtage des métriques</p>
</li>
</ul>
</div>
<h1 id="_pourquoi_monitorer_vos_applications" class="sect0">Pourquoi monitorer vos applications ?</h1>
<div class="paragraph">
<p>La réponse est multiple et sera forcément lié à votre environnement de production et votre environnement métier :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Evolution de stocks</p>
</li>
<li>
<p>Impact des actions marketing sur les demandes client</p>
</li>
<li>
<p>Usage CPU, RAM</p>
</li>
<li>
<p>Temps de réponse des requêtages DB</p>
</li>
<li>
<p>Serveur Up/Down</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<h1 id="_mise_en_oeuvre" class="sect0">Mise en oeuvre</h1>
<div class="paragraph">
<p>Au-delà de nombreuses fonctionnalités offertes par Prometheus, l&#8217;un des principaux avantages de ce dernier est sa rapidité et sa facilité de mise en oeuvre.</p>
</div>
<div class="paragraph">
<p>Pour vous montrer cela, nous nous appuierons sur <a href="https://data.keolis-rennes.com/">l&#8217;Open Data du réseau de vélo de Rennes Métropole</a>. Nous allons monitorer l&#8217;ensemble des stations de vélos rennais et visualiser en temps réel les emplacements et vélos disponibles pour chacune d&#8217;entre elles.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Mise à disposition d&#8217;un Endpoint Prometheus</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le format de données des métriques Prometheus est simple et très souple (système de clé/valeur appelé label). Il est possible de modéliser différentes dimensions d&#8217;une même métrique via un ou plusieurs labels.</p>
</div>
<div class="paragraph">
<p>Une métrique est modélisée par une ou plusieurs lignes en text/plain contenant :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le nom de la métrique</p>
</li>
<li>
<p>les labels de la métrique</p>
</li>
<li>
<p>la valeur de la métrique</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Exemple : métrique fournissant le nombre de vélos disponibles à Rennes à l&#8217;instant donné</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">bikes_available{station="SAINTE THERESE"} 11
bikes_available{station="SAINTE-ANNE"} 12</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dans l&#8217;exemple précédent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bikes_available</strong> correspond au nom de la métrique</p>
</li>
<li>
<p><strong>station</strong> est un label fournissant le nom du dock vélo (il est possible de fournir autant de labels que nécessaire)</p>
</li>
<li>
<p>les valeurs <strong>11</strong> et <strong>12</strong> correspondent aux nombres de vélos disponibles dans les 2 stations désignées ici</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Aussi, afin de fournir en temps réel les données à Prometheus, il suffit de fournir une URL avec pour contenu les données attendues dans ce format. Pour cela, nous utiliserons Spring Boot mais il est bien sûr possible d&#8217;utiliser votre langage/plateforme favori.</p>
</div>
<div class="paragraph">
<p>Le code suivant fournit 2 métriques via <a href="https://data.keolis-rennes.com/">l&#8217;API OpenData</a> du réseau de vélos de Rennes fourni par Keolis :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>bikes_available</strong> - nombre de vélos disponibles à une station donnée (identifié par un label <strong>station</strong>)</p>
</li>
<li>
<p><strong>slots_available</strong> - nombre d&#8217;emplacements de vélo disponibles à une station donnée (identifié par un label <strong>station</strong>)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@RestController
@RequestMapping("/metrics")
public class MetricsResource {

    @RequestMapping(method = RequestMethod.GET, produces={"text/plain"})
    public ResponseEntity&lt;String&gt; get() {
        RestTemplate restTemplate = new RestTemplate();
        Response response = restTemplate.getForObject("http://data.keolis-rennes.com/json/?version=2.0&amp;key=KEY_API&amp;cmd=getbikestations", Response.class);

        StringBuilder metricsBuilder = new StringBuilder();
        for (Station station : response.getOpendata().getAnswer().getData().getStations()) {
            metricsBuilder.append("bikes_available{station=\"" + station.getName() + "\"} " + station.getBikesavailable() +"\n");
            metricsBuilder.append("slots_available{station=\"" + station.getName() + "\"} " + station.getSlotsavailable() +"\n");
        }

        return new ResponseEntity&lt;&gt;(metricsBuilder.toString(), HttpStatus.OK);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remarque : par défaut, Prometheus lit les métriques d&#8217;un host donné via l&#8217;URL <strong>/metrics</strong>. Il est bien sûr possible de modifier la configuration pour utiliser une autre URL si vous ne pouvez/voulez pas fournir une URL <strong>/metrics</strong>.</p>
</div>
<div class="paragraph">
<p>Un appel à l&#8217;URL fournit la réponse suivante :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>bikes_available{station="ZAC SAINT SULPICE"} 18
slots_available{station="ZAC SAINT SULPICE"} 11
bikes_available{station="VILLEJEAN-UNIVERSITE"} 13
slots_available{station="VILLEJEAN-UNIVERSITE"} 13
bikes_available{station="TURMEL"} 13
slots_available{station="TURMEL"} 3
bikes_available{station="TNB"} 1
slots_available{station="TNB"} 27
bikes_available{station="SAINTE THERESE"} 11
slots_available{station="SAINTE THERESE"} 1
bikes_available{station="SAINTE-ANNE"} 12
slots_available{station="SAINTE-ANNE"} 12
bikes_available{station="SAINT GEORGES"} 9
slots_available{station="SAINT GEORGES"} 9
bikes_available{station="ROTONDE"} 14
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>2 - Configuration Prometheus</p>
</div>
<div class="paragraph">
<p>Une fois la datasource disponible, il est nécessaire de configurer Prometheus afin de lui indiquer à minima l&#8217;URL de la source et le timing d&#8217;interrogation de cette dernière (<strong>scrape_interval</strong>) ; il suffit pour cela fournir un fichier au format YAML tel que celui-ci :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">global:
  scrape_interval:     15s
  evaluation_interval: 15s

  labels:
      monitor: 'rennes-bike-monitor'

rule_files:

scrape_configs:
  - job_name: 'rennes-bike'

    scrape_interval: 5s # intervalle de lecture de la source de données
    scrape_timeout: 10s

    target_groups:
      - targets: ['192.168.1.17:8080'] # adresse de la source de données</code></pre>
</div>
</div>
<div class="paragraph">
<p>3 - Serveur Prometheus</p>
</div>
<div class="paragraph">
<p>Une fois le fichier de configuration prêt et la datasource démarrée, il suffit de démarrer Prometheus afin de commencer le monitoring de notre application.
Afin de simplifier l&#8217;opération, on peut bien sûr utiliser Docker (image <strong>prom/prometheus</strong>) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">~$ docker run -p 9090:9090 -v /localPath/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</code></pre>
</div>
</div>
<div class="paragraph">
<p>Prometheus est alors disponible localement sur le port 9090.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/Prometheus.png" alt="Prometheus.png">
</div>
</div>
<div class="paragraph">
<p>Sur la page d&#8217;accueil, on retrouve notamment la configuration fournie et surtout le endpoint metrics fourni via Spring Boot - on peut voir notamment si ce dernier est acessible (State "Healthy") et le temps passé depuis le dernier <strong>scraping</strong> (ie. récupération de métriques).</p>
</div>
<div class="paragraph">
<p>Afin de tester la validité des sources monitorées, il est possible de les visualiser via la console ou le moteur de graphe de Prometheus (menu Graph) :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Affichage de l&#8217;ensemble des vélos disponibles à Rennes dans un tableau (mode console) - requête Prometheus : <strong>bikes_available</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/Prometheus-Graph1.png" alt="Prometheus Graph1.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Affichage de l'évolution des vélos disponibles à la station St-Anne (mode graph) - requête Prometheus : <strong>bikes_available{station="SAINTE-ANNE"}</strong></p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/Prometheus-Graph2.png" alt="Prometheus Graph2.png">
</div>
</div>
<div class="paragraph">
<p>4 - Dashboard PromDash</p>
</div>
<div class="paragraph">
<p>Comme nous l&#8217;avons déjà dit, Prometheus fournit son propre moteur de DashBoard : PromDash. Il permet de fournir, à partir de métriques Prometheus, différents types de graphiques paramétrables selon les besoins.</p>
</div>
<div class="paragraph">
<p>Pour lancer le client PromDash, on passe une nouvelle fois par Docker (image <strong>prom/promdash</strong>) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">~$ docker run -v /tmp/prom:/tmp/prom -e DATABASE_URL=sqlite3:/tmp/prom/file.sqlite3 prom/promdash ./bin/rake db:migrate
~$ docker run -p 3000:3000 -v /tmp/prom:/tmp/prom -e DATABASE_URL=sqlite3:/tmp/prom/file.sqlite3 prom/promdash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remarque : la première commande permet d&#8217;initialiser localement la base de données de PromDash.</p>
</div>
<div class="paragraph">
<p>Encore une fois, la configuration de PromDash est très simple :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Référencement du serveur Prometheus :</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/PromDash-Server.png" alt="PromDash Server.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Création d&#8217;un nouveau Dashboard au sein d&#8217;un Directory PromDash :</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/PromDash-Dashboard.png" alt="PromDash Dashboard.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Une fois le Dashboard créée, il est alors possible de créer autant de graphiques que l&#8217;on désire - par exemple, un graphique affichant les vélos et slots disponibles à la station St-Anne :</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/PromDash-Graph.png" alt="PromDash Graph.png">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Il est alors possible de monitorer cette station depuis une URL dédiée :</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/prometheus/PromDash-Monitoring.png" alt="PromDash Monitoring.png">
</div>
</div>
<div class="paragraph">
<p>Comme vous avez pu le voir, il est extrêmement simple et rapide (quelques minutes) de mettre en oeuvre un système de monitoring via Prometheus. Il est bon de rappeler qu&#8217;il est impensable de partir en production sans monitoring ; Prometheus peut donc vous aider sur ce point dès aujourd&#8217;hui.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Les sources de cet article sont disponibles sur le <a href="https://github.com/Ellixo/prometheus-demo">Repository GitHub Ellixo</a></p>
</div>
</div>
</div>
        </section>

    
        <section class="post-comments">
          <h3 id="reply-title" class="comment-reply-title">Laisser un commentaire</h3>
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'ellixo-blog'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>
    
    </article>

</main>
    <footer class="animated fadeIn" id="footer">
        <section class="colophon">
          <section class="copyright">Copyright &copy; <a href="http://www.ellixo.com">Ellixo</a> All Rights Reserved - Published with <a class="icon-ghost" href="http://hubpress.io">HubPress</a></section>
        </section>
        <section class="bottom">
          <section class="attribution">
            <a href="http://www.ellixo.com">Accueil Ellixo</a> - <a href="http://www.ellixo.com/mentions-blog.html">Mentions Légales</a>
          </section>
        </section>
    </footer>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>
    <script src="//blog.ellixo.com/themes/Ellixo/assets/js/scripts.js?v=1.0.0"></script>
    
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-63938697-1', 'auto');
    ga('send', 'pageview');

    </script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.6/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</body>
</html>
